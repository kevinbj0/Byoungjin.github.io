<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce LWC Loader</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        #agentforceChatbotDivId {
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        #errorMessage {
            color: red;
            background-color: #ffebee;
            padding: 1rem;
            border-radius: 8px;
            max-width: 600px;
        }
    </style>
</head>
<body>
    <!-- 챗봇이 렌더링될 컨테이너 -->
    <div id="agentforceChatbotDivId"></div>
    <!-- 에러 메시지를 표시할 컨테이너 -->
    <div id="errorMessage" style="display:none;"></div>

    <script src="https://connect-flow-8014--ps.sandbox.lightning.force.com/lightning/lightning.out.js"></script>
    <script>
        const myApiUrl = 'https://byoungjin-github-io.vercel.app/api/getToken'; // Vercel 배포 URL 사용
        const salesforceUrl = 'https://connect-flow-8014--ps.sandbox.lightning.force.com/';
        const appName = 'c:zzChatBot_Aura';
        const componentName = 'c:sj_Chatbot';

        const lwcAttributes = {
            isDarkMode: false,
            chatbot_width: '350px',
            chatbot_height: '600px'
        };

        // 에러 메시지를 화면에 표시하는 함수
        function displayError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // API를 호출하여 토큰을 가져오고 LWC를 로드하는 로직
        fetch(myApiUrl)
            .then(response => {
                // 응답이 'ok'가 아니면(예: 400, 401, 500 에러), 응답 본문을 JSON으로 파싱하여 에러를 발생시킨다.
                // 이렇게 하면 .catch 블록으로 바로 이동하게 된다.
                if (!response.ok) {
                    return response.json().then(errorData => {
                        // Salesforce에서 온 구체적인 에러 메시지를 포함하여 에러를 던진다.
                        throw new Error(`백엔드 API 에러 (Status: ${response.status}): ${JSON.stringify(errorData)}`);
                    });
                }
                // 응답이 정상이면 JSON 데이터를 반환한다.
                return response.json();
            })
            .then(data => {
                const accessToken = data.access_token;
                if (!accessToken) {
                    throw new Error("응답 데이터에 access_token이 없습니다.");
                }
                
                console.log("백엔드를 통해 안전하게 토큰을 받았습니다:", accessToken);

                // $Lightning 유틸리티를 사용하여 LWC 컴포넌트를 로드한다.
                $Lightning.use(appName,
                    () => { // 성공 콜백
                        $Lightning.createComponent(
                            componentName,
                            lwcAttributes,
                            "agentforceChatbotDivId",
                            (cmp, err) => { // 컴포넌트 생성 콜백
                                if (err) {
                                    console.error('LWC 컴포넌트 생성 실패:', err);
                                    displayError(`LWC 컴포넌트를 생성하는 데 실패했습니다2: ${err}`);
                                    return;
                                }
                                console.log('LWC 컴포넌트가 성공적으로 생성되었습니다.');
                            }
                        );
                    },
                    salesforceUrl,
                    accessToken
                );
            })
            .catch(error => {
                // fetch 과정이나 그 이후의 모든 에러를 여기서 잡는다.
                console.error('전체 프로세스 호출 실패2:', error);
                displayError(`오류가 발생했습니다2: ${error.message}`);
            });
    </script>
</body>
</html>
